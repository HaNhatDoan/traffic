<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Hệ Thống Dự Báo Giao Thông</title>

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet">
        <!-- Leaflet CSS (Bản đồ) -->
        <link rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <!-- Font Awesome -->
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

        <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        #map { height: 600px; width: 100%; border-radius: 8px; border: 2px solid #dee2e6; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .loading { display: none; text-align: center; margin: 10px; }
        .legend-item { display: flex; align-items: center; margin-right: 15px; font-size: 0.9rem; }
        .color-box { width: 15px; height: 15px; margin-right: 5px; display: inline-block; }
    </style>
    </head>
    <body>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar: Điều khiển -->
                <div class="col-md-3">
                    <h4 class="mb-4 text-primary"><i
                            class="fas fa-traffic-light"></i> Traffic AI</h4>

                    <!-- Phần 1: Dự báo -->
                    <div class="card">
                        <div class="card-header bg-primary text-white"><i
                                class="fas fa-chart-line"></i> Dự Báo Ùn Tắc
                            (Next Day)</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Chọn Khu Vực
                                    (Region)</label>
                                <select id="regionSelect" class="form-select">
                                    <option value>Đang tải...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Chọn Tuyến
                                    Đường</label>
                                <select id="roadSelect" class="form-select"
                                    disabled>
                                    <option value>Chọn khu vực trước</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ngày Dự Báo (Tự
                                    động)</label>
                                <!-- Input readonly để hiển thị ngày server trả về -->
                                <input type="text" id="dateDisplay"
                                    class="form-control" value="Chờ dự báo..."
                                    readonly style="background-color: #e9ecef;">
                            </div>
                            <button class="btn btn-success w-100"
                                onclick="predictCongestion()">
                                <i class="fas fa-search"></i> Xem Dự Báo
                            </button>
                            <div id="predLoading"
                                class="loading text-primary mt-2">
                                <i class="fas fa-spinner fa-spin"></i> Đang xử
                                lý AI...
                            </div>
                        </div>
                    </div>

                    <!-- Phần 2: Tìm đường -->
                    <div class="card">
                        <div class="card-header bg-danger text-white"><i
                                class="fas fa-route"></i> Gợi Ý Tuyến
                            Đường</div>
                        <div class="card-body">
                            <p class="small text-muted mb-2">Nhập tên đường để
                                tìm lộ trình tối ưu (VD: A4, M5, A1...).</p>

                            <div class="mb-2">
                                <label class="form-label">Đường đi
                                    (Start)</label>
                                <input class="form-control" list="roadOptions"
                                    id="startRoadInput"
                                    placeholder="Nhập tên đường (VD: A4)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Đường đến
                                    (End)</label>
                                <input class="form-control" list="roadOptions"
                                    id="endRoadInput"
                                    placeholder="Nhập tên đường (VD: A40)">
                            </div>

                            <datalist id="roadOptions">
                                <!-- JS sẽ điền dữ liệu vào đây -->
                            </datalist>

                            <button class="btn btn-danger w-100"
                                onclick="findRoute()">
                                <i class="fas fa-directions"></i> Tìm Đường Tối
                                Ưu
                            </button>

                            <div id="routeInfo"
                                class="mt-2 small text-success fw-bold p-2 bg-light border rounded"
                                style="display:none"></div>
                        </div>
                    </div>
                </div>

                <!-- Main: Bản đồ và Biểu đồ -->
                <div class="col-md-9">
                    <div class="card">
                        <div class="card-body p-2">
                            <div id="map"></div>
                            <div
                                class="mt-2 d-flex flex-wrap justify-content-center">
                                <span class="legend-item"><span
                                        class="color-box"
                                        style="background:green"></span>Rất
                                    thoáng</span>
                                <span class="legend-item"><span
                                        class="color-box"
                                        style="background:lime"></span>Thoáng</span>
                                <span class="legend-item"><span
                                        class="color-box"
                                        style="background:yellow"></span>Bình
                                    thường</span>
                                <span class="legend-item"><span
                                        class="color-box"
                                        style="background:orange"></span>Đông</span>
                                <span class="legend-item"><span
                                        class="color-box"
                                        style="background:red"></span>Rất
                                    đông</span>
                            </div>
                        </div>
                    </div>

                    <div class="card" id="chartCard" style="display:none;">
                        <div class="card-header">Kết quả dự báo lưu lượng xe 24h
                            tới</div>
                        <div class="card-body">
                            <canvas id="trafficChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <script>
    // --- 1. CẤU HÌNH BẢN ĐỒ ---
    const map = L.map('map').setView([51.505, -0.09], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Traffic AI System'
    }).addTo(map);

    let routeLayer = L.layerGroup().addTo(map);
    let trafficLayer = L.layerGroup().addTo(map);
    let intersectionLayer = L.layerGroup().addTo(map);
    let chartInstance = null;

    const colors = { 1: 'green', 2: 'lime', 3: '#ffd700', 4: 'orange', 5: 'red' };
    const API_BASE = 'http://127.0.0.1:5000/api';

    // --- 2. KHỞI TẠO ---
    $(document).ready(function() {
        // Load Regions
        fetch(`${API_BASE}/regions`)
            .then(res => res.json())
            .then(data => {
                const select = $('#regionSelect');
                select.empty().append('<option value="">-- Chọn Khu Vực --</option>');
                data.forEach(r => select.append(`<option value="${r}">${r}</option>`));
                
                // Load gợi ý tên đường (mẫu)
                if(data.length > 0) {
                    loadRoadsForSuggestion(data[0]);
                }
            });

        loadIntersections();
        loadTrafficLayer();
    });

    // --- 3. CÁC HÀM HỖ TRỢ ---
    function loadRoadsForSuggestion(regionName) {
        fetch(`${API_BASE}/roads-by-region?region=${encodeURIComponent(regionName)}`)
            .then(res => res.json())
            .then(data => {
                const dataList = $('#roadOptions');
                data.forEach(r => {
                    if(dataList.find(`option[value="${r}"]`).length === 0){
                        dataList.append(`<option value="${r}">`);
                    }
                });
            });
    }

    $('#regionSelect').change(function() {
        const region = $(this).val();
        if(!region) return;
        
        fetch(`${API_BASE}/roads-by-region?region=${encodeURIComponent(region)}`)
            .then(res => res.json())
            .then(data => {
                const select = $('#roadSelect');
                select.prop('disabled', false).empty();
                data.forEach(r => select.append(`<option value="${r}">${r}</option>`));
                
                const dataList = $('#roadOptions');
                dataList.empty();
                data.forEach(r => dataList.append(`<option value="${r}">`));
            });
    });

    function loadTrafficLayer() {
        fetch(`${API_BASE}/traffic-data`)
            .then(res => res.json())
            .then(data => {
                data.forEach(seg => {
                    if(seg.polyline) {
                        const coords = JSON.parse(seg.polyline);
                        L.polyline(coords, {
                            color: colors[seg.level] || 'gray',
                            weight: 5, opacity: 0.6
                        }).bindPopup(`Level: ${seg.level}`).addTo(trafficLayer);
                    }
                });
            });
    }

    function loadIntersections() {
        fetch(`${API_BASE}/intersections`)
            .then(res => res.json())
            .then(data => {
                data.forEach(node => {
                    L.circleMarker([node.lat, node.lon], {
                        radius: 3, fillColor: 'blue', color: '#fff', weight: 1, opacity: 1, fillOpacity: 0.6
                    }).bindPopup(`Node ID: ${node.id}`).addTo(intersectionLayer);
                });
            });
    }

    // --- 4. DỰ BÁO ÙN TẮC (ĐÃ SỬA LỖI MAP FUNCTION) ---
    function predictCongestion() {
        const road = $('#roadSelect').val();
        
        if(!road) {
            alert("Vui lòng chọn tuyến đường!");
            return;
        }

        $('#predLoading').show();
        $('#chartCard').hide();

        // Gọi API
        fetch(`${API_BASE}/predict-daily-congestion?road=${encodeURIComponent(road)}`)
            .then(res => res.json())
            .then(response => {
                $('#predLoading').hide();
                
                if(response.error) {
                    alert(response.error);
                    return;
                }

                // Cập nhật ngày lên giao diện
                $('#dateDisplay').val(response.info.date);
                
                // Hiển thị biểu đồ
                $('#chartCard').show();
                
                // QUAN TRỌNG: Truyền response.data (mảng) thay vì response (object)
                drawChart(response.data, road + " (" + response.info.date + ")");
            })
            .catch(err => {
                $('#predLoading').hide();
                alert("Lỗi kết nối: " + err);
            });
    }

    function drawChart(dataArray, title) {
        const ctx = document.getElementById('trafficChart').getContext('2d');
        
        // Đảm bảo dataArray là một mảng trước khi map
        if (!Array.isArray(dataArray)) {
            console.error("Dữ liệu không phải là mảng:", dataArray);
            return;
        }

        const labels = dataArray.map(d => `${d.hour}:00`);
        const volumes = dataArray.map(d => d.predicted_volume);
        const bgColors = dataArray.map(d => colors[d.congestion_level]);

        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Lưu lượng dự báo: ${title}`,
                    data: volumes,
                    backgroundColor: bgColors,
                    borderColor: '#333',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } }
            }
        });
    }

// --- 5. TÌM ĐƯỜNG ---
    function findRoute() {
        const source = $('#startRoadInput').val().trim();
        const target = $('#endRoadInput').val().trim();
        
        if(!source || !target) {
            alert("Vui lòng nhập tên đường (VD: M4, A5)");
            return;
        }

        // Hiển thị trạng thái đang xử lý
        $('#routeInfo').removeClass('alert-success alert-danger').addClass('alert-info')
                      .html('<i class="fas fa-spinner fa-spin"></i> Đang tính toán lộ trình...').show();
        
        // Gọi API
        fetch(`${API_BASE}/find-routes?source=${encodeURIComponent(source)}&target=${encodeURIComponent(target)}`)
            .then(async res => {
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || `Lỗi ${res.status}`);
                return data;
            })
            .then(data => {
                // 1. Xóa đường cũ trên bản đồ
                routeLayer.clearLayers();
                
                if(data.results && data.results.length > 0) {
                     const route = data.results[0];
                     
                     // 2. Vẽ đường lên bản đồ (nếu có toạ độ)
                     if(route.coords && route.coords.length > 0) {
                         const line = L.polyline(route.coords, {color: 'blue', weight: 6, opacity: 0.8}).addTo(routeLayer);
                         // Tạo hiệu ứng mũi tên hoặc dash nếu thích
                         L.polyline(route.coords, {color: 'white', weight: 2, dashArray: '10, 10'}).addTo(routeLayer);
                         
                         map.fitBounds(line.getBounds()); // Zoom vào đường vừa tìm
                     }

                     // --- 3. HIỂN THỊ KẾT QUẢ RA MÀN HÌNH (THAY VÌ CONSOLE) ---
                     
                     // Nối các tên đường bằng mũi tên
                     const pathString = route.path_ids.join(' <i class="fas fa-arrow-right text-muted" style="font-size:0.8rem"></i> ');
                     
                     const resultHTML = `
                        <div>
                            <strong><i class="fas fa-check-circle"></i> Tìm thấy lộ trình tối ưu!</strong>
                            <div class="mt-2 mb-2">
                                <span class="badge bg-primary">Tổng trọng số: ${route.total_weight}</span>
                                <span class="badge bg-secondary">Số bước: ${route.path_ids.length}</span>
                            </div>
                            <hr style="margin: 5px 0;">
                            <div style="max-height: 150px; overflow-y: auto; font-size: 0.9rem; background: #fff; padding: 5px; border-radius: 4px; border: 1px solid #eee;">
                                ${pathString}
                            </div>
                        </div>
                     `;

                     $('#routeInfo').removeClass('alert-info alert-danger').addClass('alert-success')
                                    .html(resultHTML).show();

                } else {
                     $('#routeInfo').removeClass('alert-info alert-success').addClass('alert-warning')
                                    .text("Tìm thấy đường nhưng không có dữ liệu chi tiết.").show();
                }
            })
            .catch(err => {
                console.error(err);
                $('#routeInfo').removeClass('alert-info alert-success').addClass('alert-danger')
                               .html(`<strong><i class="fas fa-exclamation-triangle"></i> Lỗi:</strong> ${err.message}`).show();
            });
    }
</script>

    </body>
</html>